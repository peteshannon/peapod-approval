<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PeaPod Script Approval - Baringa Partners</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      padding: 0;
      background: #0f1419;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      color: #ffffff;
      min-height: 100vh;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    
    /* Header Section */
    .header {
      text-align: center;
      margin-bottom: 50px;
      animation: fadeIn 0.6s ease-in;
    }
    
    .logo-container {
      margin-bottom: 20px;
    }
    
    .header-logo {
      max-width: 300px;
      height: auto;
      display: block;
      margin: 0 auto;
    }
    
    .header h1 {
      color: #00d4ff;
      font-size: 36px;
      font-weight: 700;
      margin: 20px 0 15px 0;
      letter-spacing: -0.5px;
    }
    
    .header p {
      color: #00d4ff;
      font-size: 18px;
      margin: 0;
      font-weight: 300;
      opacity: 0.9;
    }
    
    /* Loading State */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #00d4ff;
      font-size: 18px;
    }
    
    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    
    /* Error State */
    .error {
      background: linear-gradient(135deg, #3d1e1e 0%, #2a1e1e 100%);
      border: 2px solid #ff4444;
      border-radius: 12px;
      padding: 30px;
      margin: 30px 0;
      text-align: center;
    }
    
    .error h2 {
      color: #ff4444;
      margin-bottom: 15px;
    }
    
    .error p {
      color: #e0d0c0;
      line-height: 1.6;
    }
    
    /* Info Cards */
    .info-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
      animation: slideUp 0.8s ease-out;
    }
    
    .info-card {
      background: linear-gradient(135deg, #243447 0%, #1e2d3d 100%);
      border: 1px solid #2a3f54;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .info-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 212, 255, 0.2);
    }
    
    .info-card .icon {
      font-size: 32px;
      margin-bottom: 10px;
    }
    
    .info-card h3 {
      color: #00d4ff;
      font-size: 16px;
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .info-card p {
      color: #8ba3b8;
      font-size: 14px;
      line-height: 1.5;
    }
    
    /* Episode Details Card */
    .episode-details {
      background: linear-gradient(135deg, #243447 0%, #1e2d3d 100%);
      border: 1px solid #2a3f54;
      border-radius: 12px;
      padding: 25px;
      margin: 30px 0;
    }
    
    .episode-details h2 {
      color: #00d4ff;
      font-size: 20px;
      margin: 0 0 20px 0;
      font-weight: 600;
    }
    
    .detail-row {
      display: flex;
      align-items: baseline;
      margin-bottom: 12px;
    }
    
    .detail-label {
      color: #8ba3b8;
      min-width: 120px;
      font-size: 14px;
    }
    
    .detail-value {
      color: #ffffff;
      font-weight: 500;
      font-size: 15px;
    }
    
    /* Instructions */
    .instructions {
      background: linear-gradient(135deg, #3d2a1e 0%, #2a1e1e 100%);
      border: 2px solid #ff6b35;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      animation: slideUp 1s ease-out;
    }
    
    .instructions h3 {
      color: #ff6b35;
      font-size: 20px;
      margin: 0 0 15px 0;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .instructions ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .instructions li {
      color: #e0d0c0;
      padding: 10px 0;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      border-bottom: 1px solid rgba(255, 107, 53, 0.2);
    }
    
    .instructions li:last-child {
      border-bottom: none;
    }
    
    .instructions li::before {
      content: "‚úì";
      color: #00d4ff;
      font-size: 20px;
      font-weight: bold;
      flex-shrink: 0;
    }
    
    /* Form Wrapper */
    .form-wrapper {
      background: linear-gradient(135deg, #1e2d3d 0%, #243447 100%);
      border: 2px solid #2a3f54;
      border-radius: 16px;
      padding: 0;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      overflow: hidden;
      animation: fadeIn 1s ease-in;
    }
    
    .form-header {
      background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
      padding: 25px 30px;
      border-bottom: 3px solid #ff0090;
    }
    
    .form-header h2 {
      color: #0f1419;
      font-size: 24px;
      font-weight: 700;
      margin: 0;
    }
    
    .form-content {
      padding: 30px;
      background: #1a2332;
    }
    
    /* Form Elements */
    .form-group {
      margin-bottom: 25px;
    }
    
    .form-label {
      display: block;
      color: #00d4ff;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      background: #0f1419;
      border: 2px solid #2a3f54;
      border-radius: 8px;
      padding: 12px 15px;
      color: #ffffff;
      font-size: 15px;
      font-family: inherit;
      transition: border-color 0.3s ease;
    }
    
    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
      outline: none;
      border-color: #00d4ff;
    }
    
    .form-textarea {
      min-height: 400px;
      resize: vertical;
      font-family: 'Courier New', monospace;
      line-height: 1.6;
    }
    
    .form-select {
      cursor: pointer;
    }
    
    .char-count {
      text-align: right;
      color: #8ba3b8;
      font-size: 13px;
      margin-top: 5px;
    }
    
    /* Buttons */
    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      flex-wrap: wrap;
    }
    
    .btn {
      flex: 1;
      min-width: 200px;
      padding: 18px 30px;
      border: none;
      border-radius: 50px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      text-decoration: none;
      display: inline-block;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-approve {
      background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
      color: #0f1419;
      box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
    }
    
    .btn-approve:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 212, 255, 0.6);
    }
    
    .btn-reject {
      background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
      color: #ffffff;
      box-shadow: 0 4px 15px rgba(255, 68, 68, 0.4);
    }
    
    .btn-reject:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 68, 68, 0.6);
    }
    
    /* Success Message */
    .success {
      background: linear-gradient(135deg, #1e3d2a 0%, #1e2a1e 100%);
      border: 2px solid #44ff44;
      border-radius: 12px;
      padding: 40px;
      margin: 30px 0;
      text-align: center;
      animation: slideUp 0.5s ease-out;
    }
    
    .success h2 {
      color: #44ff44;
      margin-bottom: 15px;
      font-size: 28px;
    }
    
    .success p {
      color: #d0e0d0;
      line-height: 1.6;
      font-size: 16px;
    }
    
    .success .checkmark {
      font-size: 64px;
      margin-bottom: 20px;
      display: block;
    }
    
    /* Footer */
    .footer {
      text-align: center;
      margin-top: 50px;
      padding-top: 30px;
      border-top: 1px solid #2a3f54;
      animation: fadeIn 1.2s ease-in;
    }
    
    .footer p {
      font-size: 13px;
      color: #8ba3b8;
      margin: 5px 0;
    }
    
    .footer .brand {
      color: #00d4ff;
      font-weight: 600;
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 20px 15px;
      }
      
      .header h1 {
        font-size: 28px;
      }
      
      .header p {
        font-size: 16px;
      }
      
      .info-cards {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .form-content {
        padding: 20px;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      .btn {
        min-width: 100%;
      }
      
      .form-textarea {
        min-height: 300px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    
    <!-- Header -->
    <div class="header">
      <div class="logo-container">
        <img src="https://raw.githubusercontent.com/peteshannon/peapod-approval/main/assets/baringa-logo.png" alt="Baringa Logo" class="header-logo">
      </div>
      <h1>Baringa PeaPod</h1>
      <p>Podcast Script Approval System</p>
    </div>
    
    <!-- Loading State -->
    <div id="loadingState" class="loading">
      Loading your approval request
    </div>
    
    <!-- Error State -->
    <div id="errorState" class="error" style="display: none;">
      <h2>‚ö†Ô∏è Unable to Load Script</h2>
      <p id="errorMessage"></p>
    </div>
    
    <!-- Success State -->
    <div id="successState" class="success" style="display: none;">
      <span class="checkmark">‚úÖ</span>
      <h2 id="successTitle">Submission Successful!</h2>
      <p id="successMessage"></p>
    </div>
    
    <!-- Main Content -->
    <div id="mainContent" style="display: none;">
      
      <!-- Episode Details -->
      <div class="episode-details">
        <h2>üìä Episode Details</h2>
        <div class="detail-row">
          <span class="detail-label">Team:</span>
          <span class="detail-value" id="teamName">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Episode:</span>
          <span class="detail-value" id="episodeTitle">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Date:</span>
          <span class="detail-value" id="episodeDate">-</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Word Count:</span>
          <span class="detail-value" id="wordCount">-</span>
        </div>
      </div>
      
      <!-- Instructions -->
      <div class="instructions">
        <h3>‚ö†Ô∏è How to Review & Approve</h3>
        <ul>
          <li>Read through the complete podcast script below</li>
          <li>Edit the script directly in the text area if needed</li>
          <li>Add any comments for the team (optional)</li>
          <li>Click "Approve" to proceed with audio generation</li>
          <li>Click "Reject" to stop the process</li>
          <li><strong>Important:</strong> Once approved, the script will be converted to audio automatically</li>
        </ul>
      </div>
      
      <!-- Approval Form -->
      <div class="form-wrapper">
        <div class="form-header">
          <h2>Approval Form</h2>
        </div>
        <div class="form-content">
          <form id="approvalForm">
            
            <!-- Script Field -->
            <div class="form-group">
              <label class="form-label" for="scriptField">Podcast Script</label>
              <textarea 
                id="scriptField" 
                class="form-textarea" 
                placeholder="Loading script..."
                required
              ></textarea>
              <div class="char-count">
                <span id="charCount">0</span> characters | <span id="wordCountScript">0</span> words
              </div>
            </div>
            
            <!-- Comments Field -->
            <div class="form-group">
              <label class="form-label" for="commentsField">Comments (Optional)</label>
              <textarea 
                id="commentsField" 
                class="form-textarea" 
                style="min-height: 120px;"
                placeholder="Add any comments or feedback here..."
              ></textarea>
            </div>
            
            <!-- Hidden Fields -->
            <input type="hidden" id="teamNameField" name="team_name">
            <input type="hidden" id="episodeDateField" name="episode_date">
            <input type="hidden" id="episodeTitleField" name="episode_title">
            
            <!-- Buttons -->
            <div class="button-group">
              <button type="button" class="btn btn-approve" id="approveBtn">
                ‚úÖ APPROVE SCRIPT
              </button>
              <button type="button" class="btn btn-reject" id="rejectBtn">
                ‚ùå REJECT SCRIPT
              </button>
            </div>
            
          </form>
        </div>
      </div>
      
    </div>
    
    <!-- Footer -->
    <div class="footer">
      <p>This is an automated approval system from <span class="brand">PeaPod</span></p>
      <p style="font-size: 12px; color: #6a7d8f; margin-top: 10px;">
        Powered by Baringa Partners | Products & Services AI Team
      </p>
    </div>
    
  </div>

  <script>
    // Configuration
    const SPREADSHEET_ID = '1wKThYAdRTzoPfb5rMih8vMlU1LW6EfS_l7l0uR9TcoY';
    const SHEET_NAME = 'Pending_Scripts';
    const WEBHOOK_URL = 'https://hooks.zapier.com/hooks/catch/24513013/u80josc/';
    
    // Parse URL parameters
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        episodeDate: params.get('episode_date') || params.get('entry.95739314'),
        teamName: params.get('team_name') || params.get('entry.624057651'),
        episodeTitle: params.get('episode_title') || params.get('entry.1842208202')
      };
    }
    
    // Fetch script from Google Sheets
    async function fetchScript(episodeDate) {
      try {
        // Use Google Sheets JSON API (public access)
        const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;
        
        console.log('Fetching from URL:', url);
        
        const response = await fetch(url);
        const text = await response.text();
        
        console.log('Response received, length:', text.length);
        
        // Remove the Google Sheets wrapper to get pure JSON
        const jsonText = text.substring(47).slice(0, -2);
        const data = JSON.parse(jsonText);
        
        console.log('Full data from Google Sheets:', data);
        
        // Extract rows
        const rows = data.table.rows;
        console.log('Total rows:', rows.length);
        
        // Log ALL dates in the sheet
        console.log('All dates in sheet:');
        rows.forEach((row, index) => {
          const dateValue = row.c[0]?.v || '';
          const dateFormatted = row.c[0]?.f || '';
          console.log(`Row ${index}: v="${dateValue}", f="${dateFormatted}"`);
        });
        
        console.log('Looking for episode_date:', episodeDate);
        
        // Find matching row by Episode_Date (column 0)
        // Google Sheets returns dates as: Date(2025,10,16) where month is 0-indexed
        const matchingRow = rows.find(row => {
          const dateValue = row.c[0]?.v || '';
          const dateFormatted = row.c[0]?.f || '';
          
          // Parse the Date(YYYY,M,D) format from Google Sheets
          let parsedDate = '';
          if (typeof dateValue === 'string' && dateValue.startsWith('Date(')) {
            const match = dateValue.match(/Date\((\d+),(\d+),(\d+)\)/);
            if (match) {
              const year = match[1];
              const month = String(parseInt(match[2]) + 1).padStart(2, '0'); // Convert 0-indexed to 1-indexed
              const day = String(match[3]).padStart(2, '0');
              parsedDate = `${year}-${month}-${day}`;
            }
          }
          
          console.log('Checking row with dateValue:', dateValue, '‚Üí parsed:', parsedDate, 'against:', episodeDate);
          
          // Try matching the parsed date, formatted date, or raw value
          return parsedDate === episodeDate || dateFormatted === episodeDate || dateValue === episodeDate;
        });
        
        if (!matchingRow) {
          throw new Error(`No script found for episode date: ${episodeDate}. Check console for available dates.`);
        }
        
        console.log('Matching row:', matchingRow);
        console.log('Script column (c[3]):', matchingRow.c[3]);
        console.log('Script value:', matchingRow.c[3]?.v);
        console.log('Script length:', matchingRow.c[3]?.v?.length);
        
        // Extract values from the matching row
        // Column order: Episode_Date, Team_Name, Episode_Title, Full_Script, Created_Timestamp, Status
        return {
          episodeDate: matchingRow.c[0]?.v || '',
          teamName: matchingRow.c[1]?.v || '',
          episodeTitle: matchingRow.c[2]?.v || '',
          script: matchingRow.c[3]?.v || '',
          createdTimestamp: matchingRow.c[4]?.v || '',
          status: matchingRow.c[5]?.v || ''
        };
      } catch (error) {
        console.error('Error fetching script:', error);
        throw error;
      }
    }
    
    // Update character and word count
    function updateCounts() {
      const script = document.getElementById('scriptField').value;
      const charCount = script.length;
      const wordCount = script.trim() ? script.trim().split(/\s+/).length : 0;
      
      document.getElementById('charCount').textContent = charCount.toLocaleString();
      document.getElementById('wordCountScript').textContent = wordCount.toLocaleString();
    }
    
    // Submit approval
    async function submitApproval(decision) {
      const script = document.getElementById('scriptField').value;
      const comments = document.getElementById('commentsField').value;
      const teamName = document.getElementById('teamNameField').value;
      const episodeDate = document.getElementById('episodeDateField').value;
      const episodeTitle = document.getElementById('episodeTitleField').value;
      
      const payload = {
        team_name: teamName,
        episode_date: episodeDate,
        episode_title: episodeTitle,
        script: script,
        decision: decision,
        comments: comments,
        timestamp: new Date().toISOString()
      };
      
      try {
        // Disable buttons
        document.getElementById('approveBtn').disabled = true;
        document.getElementById('rejectBtn').disabled = true;
        
        const response = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
          throw new Error('Submission failed');
        }
        
        // Show success message
        document.getElementById('mainContent').style.display = 'none';
        document.getElementById('successState').style.display = 'block';
        
        if (decision === 'Approve') {
          document.getElementById('successTitle').textContent = '‚úÖ Script Approved!';
          document.getElementById('successMessage').textContent = 'Your approval has been recorded. Audio generation will begin shortly. You will receive an email when the podcast is ready.';
        } else {
          document.getElementById('successTitle').textContent = '‚ùå Script Rejected';
          document.getElementById('successMessage').textContent = 'Your rejection has been recorded. The team will be notified and no further action will be taken on this script.';
        }
        
      } catch (error) {
        console.error('Error submitting:', error);
        alert('There was an error submitting your response. Please try again or contact support.');
        
        // Re-enable buttons
        document.getElementById('approveBtn').disabled = false;
        document.getElementById('rejectBtn').disabled = false;
      }
    }
    
    // Initialize
    async function init() {
      try {
        const params = getUrlParams();
        
        if (!params.episodeDate) {
          throw new Error('Missing episode_date parameter in URL');
        }
        
        // Fetch script data
        const data = await fetchScript(params.episodeDate);
        
        // Populate form
        document.getElementById('teamName').textContent = data.teamName;
        document.getElementById('episodeTitle').textContent = data.episodeTitle;
        document.getElementById('episodeDate').textContent = data.episodeDate;
        document.getElementById('scriptField').value = data.script;
        
        // Set hidden fields
        document.getElementById('teamNameField').value = data.teamName;
        document.getElementById('episodeDateField').value = data.episodeDate;
        document.getElementById('episodeTitleField').value = data.episodeTitle;
        
        // Update counts
        updateCounts();
        document.getElementById('wordCount').textContent = document.getElementById('wordCountScript').textContent + ' words';
        
        // Show main content
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        
        // Add event listeners
        document.getElementById('scriptField').addEventListener('input', updateCounts);
        
        document.getElementById('approveBtn').addEventListener('click', () => {
          if (confirm('Are you sure you want to APPROVE this script? Audio generation will begin immediately.')) {
            submitApproval('Approve');
          }
        });
        
        document.getElementById('rejectBtn').addEventListener('click', () => {
          if (confirm('Are you sure you want to REJECT this script? This will stop all processing.')) {
            submitApproval('Reject');
          }
        });
        
      } catch (error) {
        console.error('Initialization error:', error);
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('errorState').style.display = 'block';
        document.getElementById('errorMessage').textContent = error.message;
      }
    }
    
    // Run on page load
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
